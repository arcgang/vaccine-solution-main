{"version":3,"sources":["webpack:///./src/pages/use-cases/order/eventstreams.mdx"],"names":["_frontmatter","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","props","mdxType","parentName","isMDXComponent"],"mappings":"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","file":"component---src-pages-use-cases-order-eventstreams-mdx-a4bf15c80a8aa88cd3ea.js","sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\n\nimport DefaultLayout from \"/home/runner/work/vaccine-solution-main/vaccine-solution-main/docs/node_modules/gatsby-theme-carbon/src/templates/Default.js\";\nexport const _frontmatter = {};\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <ol>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Create the following artifacts in the `}<inlineCode parentName=\"p\">{`eventstreams`}</inlineCode>{` namespace on your OpenShift cluster:`}</p>\n        <ol parentName=\"li\">\n          <li parentName=\"ol\">{`Create an EventStreams instance `}<em parentName=\"li\">{`(via the `}<a parentName=\"em\" {...{\n                \"href\": \"https://ibm.github.io/event-streams/installing/installing/#install-an-event-streams-instance\"\n              }}>{`Event Streams Custom Resource`}</a>{`)`}</em>{`.`}</li>\n          <li parentName=\"ol\">{`Create a `}<a parentName=\"li\" {...{\n              \"href\": \"https://ibm.github.io/event-streams/security/managing-access/#managing-access-to-kafka-resources\"\n            }}>{`Kafka User with SCRAM-based credentials`}</a>{`, as required by the `}<a parentName=\"li\" {...{\n              \"href\": \"https://github.com/ibm-cloud-architecture/vaccine-reefer-simulator#application-deployment\"\n            }}>{`Vaccine Reefer Simulator`}</a>{`.`}</li>\n          <li parentName=\"ol\">{`Create a `}<a parentName=\"li\" {...{\n              \"href\": \"https://ibm.github.io/event-streams/security/managing-access/#managing-access-to-kafka-resources\"\n            }}>{`Kafka User with TLS-based credentials`}</a>{`, as required by the `}<a parentName=\"li\" {...{\n              \"href\": \"https://github.com/ibm-cloud-architecture/vaccine-monitoring-agent#create-a-tls-user\"\n            }}>{`Vaccine Monitoring Agent`}</a>{`.`}</li>\n          <li parentName=\"ol\">{`Create two `}<a parentName=\"li\" {...{\n              \"href\": \"https://ibm.github.io/event-streams/getting-started/creating-topics/\"\n            }}>{`Kafka Topics`}</a>{`. This tutorial will assume the names of `}<inlineCode parentName=\"li\">{`vaccine.shipment.plans`}</inlineCode>{` respectively.`}</li>\n        </ol>\n      </li>\n    </ol>\n    <h2>{`Deploy Postgresql`}</h2>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-shell\"\n      }}>{`git clone https://github.com/ibm-cloud-architecture/vaccine-gitops.git\ncd vaccine-gitops/environments\noc apply -k \n`}</code></pre>\n    <h2>{`Deploy the Vaccine Order Service with Event Streams`}</h2>\n    <p>{`This microservice is built using maven and Quarkus extensions. In this current main project we have\nWe have already pushed the last version of this service on dockerhub, if you do not want to build it. `}</p>\n    <ol>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Ensure you are working inside the correct project via the following `}<inlineCode parentName=\"p\">{`oc`}</inlineCode>{` command:`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-shell\"\n          }}>{`export PROJECT_NAME=vaccine-solution\noc project \\${PROJECT_NAME}\n`}</code></pre>\n      </li>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Export the value of your Event Streams cluster name into an environment variable:`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-shell\"\n          }}>{`export CLUSTER_NAME=eda-dev\nexport EVENTSTREAMS_NS=eventstreams\n`}</code></pre>\n        <ul parentName=\"li\">\n          <li parentName=\"ul\">{`To check what the name of your Event Streams cluster name is do:`}\n            <pre parentName=\"li\"><code parentName=\"pre\" {...{\n                \"className\": \"language-shell\"\n              }}>{`$ oc get eventstreams -n \\${EVENTSTREAMS_NS}\nNAME           STATUS\neda-dev    Ready\n`}</code></pre>\n          </li>\n        </ul>\n      </li>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Deploy a postgres server. The orders are persisted in an external Postgres instance running on Openshift cluster. To do a simple deployment performs the following commands:`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-shell\"\n          }}>{` oc apply -f event-streams/infrastructure/service-account.yaml\n oc adm policy add-scc-to-user anyuid -z vaccine-runtime -n vaccine-solution\n oc apply -k event-streams/infrastructure/postgres\n\n`}</code></pre>\n      </li>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Get Kafka TLS user name to access Event Streams bootstrap using the external route. export this user name in KAFKA_USER environment variable:`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-shell\"\n          }}>{`oc get kafkausers -n $EVENTSTREAMS_NS \n# NAME                                CLUSTER   AUTHENTICATION   AUTHORIZATION\n# app-scram                           eda-dev   scram-sha-512    simple\n# app-tls                             eda-dev   tls              simple\nexport KAFKA_USER=app-tls\n`}</code></pre>\n      </li>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Copy Kafka TLS user certificate to target project:`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-shell\"\n          }}>{`oc get secret \\${KAFKA_USER} -n \\${EVENTSTREAMS_NS} -o json | jq -r '.metadata.namespace=\"'\\${PROJECT_NAME}'\"' | oc apply -f -\n`}</code></pre>\n      </li>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Get Kafka bootstrap server URL within`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-shell\"\n          }}>{`export KAFKA_BROKERS=$(oc get route -n \\${EVENTSTREAMS_NS} \\${CLUSTER_NAME}-kafka-bootstrap -o jsonpath=\"{.status.ingress[0].host}:443\")\n`}</code></pre>\n      </li>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Copy TLS server CA certificate from eventstreams project to local project with the command:`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-shell\"\n          }}>{`oc get secret \\${CLUSTER_NAME}-cluster-ca-cert -n \\${EVENTSTREAMS_NS} -o json | jq -r '.metadata.name=\"kafka-cluster-ca-cert\"' |jq -r '.metadata.namespace=\"'\\${PROJECT_NAME}'\"' | oc apply -f -\n`}</code></pre>\n      </li>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Deploy the order management microservice`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-shell\"\n          }}>{`oc apply -f ./apps/order-mgt/base/order-mgt-configmap.yaml\noc apply -f ./apps/order-mgt/base/order-mgt-deployconfig.yaml\n`}</code></pre>\n      </li>\n    </ol>\n    <h3>{`Deploy Debezium CDC connector`}</h3>\n    <p>{`The `}<a parentName=\"p\" {...{\n        \"href\": \"https://ibm.github.io/event-streams/connecting/setting-up-connectors/\"\n      }}>{`Event Streams product documentation`}</a>{` goes over the tasks to be done to config Kafka Connect cluster, but we can summarize them for our use case as:`}</p>\n    <ul>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`Start a Kafka connector cluster: We use the custom resource definition called `}<inlineCode parentName=\"p\">{`KafkaConnectS2I`}</inlineCode>{`, which one instance represents a Kafka connect cluster. Each connector is represented by another custom resource called `}<inlineCode parentName=\"p\">{`KafkaConnector`}</inlineCode>{`. Kafka connect needs a user access to the Brokers. We can use the TLS user as previously done (See also `}<a parentName=\"p\" {...{\n            \"href\": \"https://ibm-cloud-architecture.github.io/refarch-eda/use-cases/connect-cos/#set-up-the-kafka-connect-cluster\"\n          }}>{`this note`}</a>{` for the same type of setting). `}</p>\n        <ul parentName=\"li\">\n          <li parentName=\"ul\">\n            <p parentName=\"li\">{`Event Streams UI has a Toolbox menu with the `}<inlineCode parentName=\"p\">{`Set up a Kafka Connect environment`}</inlineCode>{` where we can download the `}<inlineCode parentName=\"p\">{`KafkaConnectS2I`}</inlineCode>{` configuration. The matching configuration is `}<a parentName=\"p\" {...{\n                \"href\": \"https://github.com/ibm-cloud-architecture/vaccine-order-mgr-pg/blob/main/environment/cdc/kafka-connect-s2i.yaml\"\n              }}>{`in this file`}</a>{` and uses predefined TLS user and cluster certificate. The cluster name is `}<inlineCode parentName=\"p\">{`connect-cluster`}</inlineCode>{`.`}</p>\n          </li>\n          <li parentName=\"ul\">\n            <p parentName=\"li\">{`Update the following values in this file: `}<inlineCode parentName=\"p\">{`bootstrapServers`}</inlineCode>{` and `}<inlineCode parentName=\"p\">{`secretName: tls`}</inlineCode>{`  to `}<inlineCode parentName=\"p\">{`secretName: <yourTLSuser>`}</inlineCode>{` and the Server ca certificate secretName like `}<inlineCode parentName=\"p\">{`kafka-cluster-ca-cert`}</inlineCode>{`.`}</p>\n            <pre parentName=\"li\"><code parentName=\"pre\" {...{\n                \"className\": \"language-yaml\"\n              }}>{`tls:\n trustedCertificates:\n   - certificate: ca.crt\n     secretName: kafka-cluster-ca-cert\n`}</code></pre>\n          </li>\n          <li parentName=\"ul\">\n            <p parentName=\"li\">{`Deploy the cluster with: `}<inlineCode parentName=\"p\">{`oc apply -f kafka-connect-s2i.yaml -n \\${EVENTSTREAMS_NS}`}</inlineCode></p>\n          </li>\n          <li parentName=\"ul\">\n            <p parentName=\"li\">{`Validate it via: `}</p>\n            <pre parentName=\"li\"><code parentName=\"pre\" {...{\n                \"className\": \"language-shell\"\n              }}>{`oc get kafkaconnects2i -n \\${EVENTSTREAMS_NS}\noc describe kafkaconnects2i connect-cluster -n \\${EVENTSTREAMS_NS}\n`}</code></pre>\n          </li>\n        </ul>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`Download the postgres plugin archive from `}<a parentName=\"p\" {...{\n            \"href\": \"https://repo1.maven.org/maven2/io/debezium/debezium-connector-postgres/1.4.0.Final/debezium-connector-postgres-1.4.0.Final-plugin.tar.gz\"\n          }}>{`debezium maven repository`}</a>{` and then add the jar files to the `}<inlineCode parentName=\"p\">{`my-plugins\\\\debezium-connector`}</inlineCode>{` folder. We need a subfolder as this connector includes multiple jars. This step was already done and the debezium connector jars are in the `}<a parentName=\"p\" {...{\n            \"href\": \"https://github.com/ibm-cloud-architecture/vaccine-order-mgr-pg/tree/main/environment/cdc/my-plugins/debezium-connector\"\n          }}>{`environment/cdc/my-plugins/debezium-connector)`}</a></p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{}}>{`├── my-plugins\n│   └── debezium-connector\n│       ├── CHANGELOG.md\n│       ├── CONTRIBUTE.md\n│       ├── COPYRIGHT.txt\n│       ├── LICENSE-3rd-PARTIES.txt\n│       ├── LICENSE.txt\n│       ├── README.md\n│       ├── README_ZH.md\n│       ├── debezium-api-1.4.0.Final.jar\n│       ├── debezium-connector-postgres-1.4.0.Final.jar\n│       ├── debezium-core-1.4.0.Final.jar\n│       ├── failureaccess-1.0.1.jar\n│       ├── guava-30.0-jre.jar\n│       ├── postgresql-42.2.14.jar\n│       └── protobuf-java-3.8.0.jar\n└── pg-connector.yaml\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`Deploy the connector configuration:`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-shell\"\n          }}>{`# pwd = .../environment/cdc/\noc start-build connect-cluster-connect --from-dir ./my-plugins/ --follow -n \\${EVENTSTREAMS_NS}\n#...\n# Storing signatures\n# Successfully pushed image-registry.openshift-image-registry.svc:5000/eventstreams/connect-cluster-connect@sha256:9315b6a6c8f904d0fb5a57f67ba4c9067c6c8264814f283151b20b9d6f147092\n# Push successful\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`Modify the `}<inlineCode parentName=\"p\">{`pg-connector.yaml`}</inlineCode>{` from the `}<inlineCode parentName=\"p\">{`environment/cdc`}</inlineCode>{` folder to configure the Postgres datasource credentials:`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-yaml\"\n          }}>{`config: \n  database.dbname: postgres\n  database.hostname: postgres.vaccineorder.svc\n  database.password: pgpwd\n  database.port: 5432\n  database.server.name: vaccine\n  database.user: postgres\n  table.whitelist: public.orderevents\n  plugin.name: pgoutput\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`Then start the connector: `}<inlineCode parentName=\"p\">{`oc apply -f pg-connector.yaml -n \\${EVENTSTREAMS_NS}`}</inlineCode></p>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`Verify it is running: `}<inlineCode parentName=\"p\">{`oc describe kafkaconnector pg-connector -n \\${EVENTSTREAMS_NS}`}</inlineCode>{`, you should see one task running. `}</p>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`Looking at the pod trace for the connector you should see a successful connection, something like:`}</p>\n      </li>\n    </ul>\n    <pre><code parentName=\"pre\" {...{}}>{`Successfully tested connection for jdbc:postgresql://postgres.vaccineorder.svc:5432/postgres with user 'postgres' \n`}</code></pre>\n    <ul>\n      <li parentName=\"ul\">{`A new topic may have been created with the name of the table replicated: `}<inlineCode parentName=\"li\">{`vaccine.public.orderevents`}</inlineCode>{` with new messages mapping the rows in the table.`}</li>\n    </ul>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"sourceRoot":""}