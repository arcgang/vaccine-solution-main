{"componentChunkName":"component---src-pages-use-cases-cold-chain-index-mdx","path":"/use-cases/cold-chain/","result":{"pageContext":{"frontmatter":{"title":"Cold-chain monitoring","description":"Cold-chain monitoring"},"relativePagePath":"/use-cases/cold-chain/index.mdx","titleType":"append","MdxNode":{"id":"c6897775-71a8-56a6-bcb0-4f67274e7c34","children":[],"parent":"5c1ac8d6-806f-50f3-aae8-6be814af7df0","internal":{"content":"---\ntitle: Cold-chain monitoring\ndescription: Cold-chain monitoring\n---\n\n- UPDATED 02/28/2021 \n\nThe vaccine lots need to be kept at a constant temperature for a period of time. The sensor telemetry data coming from the refrigerated shipping containers is processed to assess cold-chain violations.\n\nThe solution for this use case includes streaming telemetry events, a stateful microservice to implement aggregation & alarm generation, and integration with a microservice to log issues against the refrigerated shipping container.\n\n## Components involved in this use case\n\n* [Vaccine Refrigerator container Simulator](https://github.com/ibm-cloud-architecture/vaccine-reefer-simulator)\n* [Vaccine Reefer Monitoring Agent](https://github.com/ibm-cloud-architecture/vaccine-monitoring-agent)\n* [IBM Event Streams](https://ibm.github.io/event-streams/) or Strimzi Kafka\n\n![Architecture diagram](./images/cc-components.png)\n\n*\\*The reefer manager is not done yet*\n\n## Understand the components\n\n* The Reefer simulator is a python Flask app, which supports simple API to control the Refrigerator container simulation. It is described in [this note](/solution/reefer-iot/), also see next section to deploy it on OpenShift.\n* The Monitoring Agent is a Quarkus app, with Kafka Streams, reactive messaging to monitor the cold chain with stateful operations. It also call the Anomaly detection service. Implementation details can be read in [this note](/solution/cold-monitoring/).\n\n## Run on OpenShift\n\n### Pre-requisites\n\n**IMPORTANT:** If you are sharing the IBM Event Streams instance with other people for this tutorial, you may want to add a unique suffix to the name of the resources to be created next, such as topics, projects, etc. If so, make sure you provide the appropriate name for these throught the rest of the tutorial.\n\n1. Create the following artifacts in the `eventstreams` namespace on your OpenShift cluster (_NOTE: If you happened to have an existing IBM Event Streams instance on a different namespace already, you don't need to create an new one but make sure you use the appropriate namespace name throughout the rest of the tutorial_). We will refer to this namespace as `YOUR_EVENT_STREAMS_NAMESPACE` throughout this tutorial:\n\n   1. Create an EventStreams instance _(via the [Event Streams Custom Resource](https://ibm.github.io/event-streams/installing/installing/#install-an-event-streams-instance))_.\n   1. Create a [Kafka User with SCRAM-based credentials](https://ibm.github.io/event-streams/security/managing-access/#managing-access-to-kafka-resources), as required by the [Vaccine Reefer Simulator](https://github.com/ibm-cloud-architecture/vaccine-reefer-simulator#application-deployment).\n   1. Create a [Kafka User with TLS-based credentials](https://ibm.github.io/event-streams/security/managing-access/#managing-access-to-kafka-resources), as required by the [Vaccine Monitoring Agent](https://github.com/ibm-cloud-architecture/vaccine-monitoring-agent#create-a-tls-user).\n   1. Create two [Kafka Topics](https://ibm.github.io/event-streams/getting-started/creating-topics/). One for the container telemetries events and another for the vaccine cold-chain violation alert events. These topics will be refered as `YOUR_TELEMETRIES_TOPIC` and `YOUR_REEFER_TOPIC` respectively throughout this tutorial. For the instructions on this tutorial, we will assume the names for these two topics to be `reefers.telemetries` and `vaccine.reefers` respectively.\n\n1. Create a new project that will be used for the deployment of all other components. This will be refered as `YOUR_PROJECT_NAME` throughout the rest of this tutorial. For the instructions on this tutorial, We will assume the name for the project is `vaccine-solution`.\n1. [OpenShift CLI](https://cloud.ibm.com/docs/openshift?topic=openshift-openshift-cli) on your local environment.\n1. [jq](https://stedolan.github.io/jq/) on your local environment.\n1. [Kustomize](https://kubectl.docs.kubernetes.io/installation/kustomize/) for one script deploy\n1. Use a Terminal and the `oc` cli. If you want to access the code source you can clone the two main repositories of this solution:\n\n  ```shell\n  git clone https://github.com/ibm-cloud-architecture/vaccine-gitops\n  git clone https://github.com/ibm-cloud-architecture/vaccine-reefer-simulator\n  git clone https://github.com/ibm-cloud-architecture/vaccine-monitoring-agent\n  ```\n\n### TL;DR  - One Click Deploy\n\nGo to `vaccine-gitops` folder and do the following steps:\n\n* Set your personal deployment parameters within the   `scripts/env.sh` file\n* Use the `oc login --token...  --server ....` command to log to the OpenShift cluster. (From the OpenShift admin console, top right menu)\n* Start `./scripts/deployColdChainWithEventStreams.sh --skip-login`\n* The following pods should be up and running:\n\n ```shell\n  NAME                                        READY   STATUS    RESTARTS   AGE\n  reefer-monitoring-agent-7dd5f7ccd9-z4cf9    1/1     Running   0          106s\n  vaccine-reefer-simulator-669c5f5d8b-7mms4   1/1     Running   0          105s\n ```\n\n* Go to the [demonstration section](#scenario-script) to run the demo.\n\n### Deploy the solution manually\n\nIf you want to do this scenario as a lab, then this section addresses how to build and deploy the components to OpenShift:\n\n#### Deploy the Vaccine Reefer Simulator\n\nTo get more details of this Python Flask application [read this note](/solution/reefer-iot/).\n\n1. Export your project name and ensure you are working in it from now on via the following commands:\n\n  ```shell\n  export PROJECT_NAME=<YOUR_PROJECT_NAME>\n  oc project ${PROJECT_NAME}\n  ```\n\n  where\n\n   - `<YOUR_PROJECT_NAME>` is the name for the project you created in the previous [pre-requisites](#pre-requisites) section where all the components for this cold chain solution will be deployed into.\n\n1. Export the value of your Event Streams cluster name and the namespace it is installed on to environment variables:\n\n  ```shell\n  export CLUSTER_NAME=<YOUR_CLUSTER_NAME>\n  export EVENTSTREAMS_NS=<YOUR_EVENT_STREAMS_NAMESPACE>\n  ```\n\n  where\n\n   - `<YOUR_EVENT_STREAMS_NAMESPACE>` is the name where you installed your IBM Event Streams instance in the [pre-requisites](#pre-requisites) section above.\n   - `<YOUR_CLUSTER_NAME>` is the name of your IBM Event Streams cluster which can be found with the following `oc` command:\n\n   ```shell\n   $ oc get eventstreams -n ${EVENTSTREAMS_NS}\n   NAME           STATUS\n   eda-dev    Ready\n   ```\n\n1. Create a ConfigMap named `reefer-simul-cm` to hold the configuration for our Vaccine Reefer Simulator component with the following `oc` command:\n\n  ```shell\n  oc create configmap reefer-simul-cm \\\n  --from-literal=KAFKA_MAIN_TOPIC=<YOUR_TELEMETRY_TOPIC> \n  ```\n\n  where\n\n   - `<YOUR_TELEMETRY_TOPIC>` is the name of the topic that will get the container telemetries events you created in the [pre-requisites](#pre-requisites) section.\n   - `<YOUR_KAFKA_BOOTSTRAP_EXTERNAL_ADDRESS>` is your IBM Event Streams **External** cluster bootstrap address presented to you during the creation of your SCRAM-based KafkaUser you went through in the [pre-requisites](#pre-requisites) section. You can get that value again by executing the following `oc` command:\n    ```shell\n    oc get route -n ${EVENTSTREAMS_NS} ${CLUSTER_NAME}-kafka-bootstrap -o jsonpath=\"{.status.ingress[0].host}:443\"\n    ```\n\n1. Create a Secret named `reefer-simul-secret`, which will hold your SCRAM Kafka User credentials you created in the [pre-requisites](#pre-requisites) section, with the following `oc` command:\n\n  ```shell\n  oc create secret generic reefer-simul-secret \\\n  --from-literal=KAFKA_BROKERS=<YOUR_KAFKA_BOOTSTRAP_EXTERNAL_ADDRESS>\n  ```\n\n  where\n\n   - `<YOUR_SCRAM_KAFKA_USER_USERNAME>` is the name you gave in the [pre-requisites](#pre-requisites) section when you generated the SCRAM credentials. The generation of the SCRAM credential created a KafkaUser object behind the scenes with the name you specified. If you don't remember that name or you want to verify it, you can use the following `oc` command:\n   ```shell\n   $ oc get kafkausers -n ${EVENTSTREAMS_NS}\n   NAME                    CLUSTER         AUTHENTICATION   AUTHORIZATION\n   scram-user           eda-dev     scram-sha-512    simple\n   ```\n   - `<YOUR_SCRAM_KAFKA_USER_PASSWORD>` is the password that IBM Event Streams generated for the KafkaUser that got created behind the scenes when you generated the SCRAM credentials in the [pre-requisites](#pre-requisites) section. You can retrieve that password with the following `oc` command:\n   ```shell\n   oc get secret <YOUR_SCRAM_KAFKA_USER_USERNAME> -n ${EVENTSTREAMS_NS} -o jsonpath='{.data.password}' | base64 -D\n   ```\n\n1. Copy the server-side public TLS certificate of your IBM Event Streams instance to your local project so that the Vaccine Reefer Simulator application is able to establish secure connection with your IBM Event Streams instance:\n\n  ```shell\n  oc get secret ${CLUSTER_NAME}-cluster-ca-cert -n ${EVENTSTREAMS_NS} -o json | jq -r '.metadata.name=\"kafka-cluster-ca-cert\"' | jq --arg project_name \"${PROJECT_NAME}\" -r '.metadata.namespace=$project_name' | oc apply -f -\n  ```\n  _\\*NOTE: We are copying and renaming the certificate in a single command to minimize the need for editing deployment documents. That is, we are providing the server-side TLS certificate in the secret the Vaccine Reefer Simulator and the Vaccine Monitoring Agent microservices are expecting to find it._\n\n1. Compile, build the docker image and push to the registry\n\n  ```shell\n  # In the vaccine simulator project \n  docker build -t ibmcase/vaccine-reefer-simulator  .\n  docker push ibmcase/vaccine-reefer-simulator \n  ```\n\n1. Deploy Vaccine Reefer Simulator microservice components (application plus a service and a route to make it accessible) via the following `oc apply` command:\n\n  ```shell\n  oc apply -f https://raw.githubusercontent.com/ibm-cloud-architecture/vaccine-reefer-simulator/master/config/deployment.yaml\n  oc apply -f https://raw.githubusercontent.com/ibm-cloud-architecture/vaccine-reefer-simulator/master/config/deployment.yaml\n  ```\n\n   - You should see the following output:\n\n   ```shell\n   service/vaccine-reefer-simulator created\n   route.route.openshift.io/vaccine-reefer-simulator created\n   odeployment.apps/vaccine-reefer-simulator created\n   ```\n\n   - You can verify the deployment state with the following `oc` command:\n\n   ```shell\n   oc get pods\n   NAME                                       READY   STATUS    RESTARTS   AGE\n   vaccine-reefer-simulator-7dcfcf5cb-4nvl7   1/1     Running   0          5m55s\n   ```\n\n   or the via the Openshift console:\n\n   ![2](./images/simul-app-ocp.png)\n\n  \\*_NOTE: If you want to build from scratch, clone [the repository](https://github.com/ibm-cloud-architecture/vaccine-reefer-simulator) and follow the README._\n\n1. Get the route to access the Vaccine Reefer Simulator application with the `oc get routes` command.\n\n\n#### Deploy the Vaccine Monitoring Agent\n\nTo get more detail of this Java Quarkus microprofile application [read this note](/solution/cold-monitoring/). The project repository is in this [GitHub repository](https://github.com/ibm-cloud-architecture/vaccine-monitoring-agent). Follow the steps below to get the Vaccine Monitoring Agent microservice deployed on your OpenShift cluster:\n\n\n1. Ensure you are working inside the correct project via the following `oc` command:\n\n  ```shell\n  oc project ${PROJECT_NAME}\n  ```\n\n1. Export the value of your TLS-based KafkaUser name and a unique identifier for the reources to be created into your OpenShift cluster as environment variables so that the following steps in this section can make use of these.\n\n  ```shell\n  export TLS_USER=<YOUR_TLS_USER>\n  # we use tls-user\n  export YOUR_SUFFIX=<UNIQUE_IDENTIFIER>\n  ```\n\n  where\n\n   - `<YOUR_TLS_USER>` is the name you gave when creating the tls credentials in the [pre-requisites](#pre-requisites) section. If you don't remember the tls KafkaUser you created, you can check it out with the following `oc` command:\n    ```shell\n    $ oc get kafkausers -n ${EVENTSTREAMS_NS}\n    NAME                  CLUSTER         AUTHENTICATION   AUTHORIZATION\n    tls-user             eda-dev     tls              simple\n    ```\n    _\\*NOTE: We are copying and renaming the credentials in a single command to minimize the need for editing deployment documents._\n   - `<UNIQUE_IDENTIFIER>` is a unique identifier of your choice to be used as the suffix for any resource created in OpenShift and IBM Event Streams so that it does not collide with anyone else also completing this tutorial.\n\n1. If not done so already in the previous section where we deployed the Vaccine Reefer Simulator microservice, copy the server-side public certificate of the Event Streams instance to your local project:\n\n  ```shell\n  oc get secret ${CLUSTER_NAME}-cluster-ca-cert -n ${EVENTSTREAMS_NS} -o json | jq -r '.metadata.name=\"kafka-cluster-ca-cert\"' | jq --arg project_name \"${PROJECT_NAME}\" -r '.metadata.namespace=$project_name' | oc apply -f -\n  ```\n  _\\*NOTE: We are copying and renaming the certificate in a single command to minimize the need for editing deployment documents. That is, we are providing the server-side TLS certificate in the secret the Vaccine Reefer Simulator and the Vaccine Monitoring Agent microservices are expecting to find it._\n\n1. Copy your TLS-based KafkaUser's credentials you created in the [pre-requisites](#pre-requisites) section to the local namespace with the following `oc` command:\n\n  ```shell\n  oc get secret ${TLS_USER} -n ${EVENTSTREAMS_NS} -o json | jq -r '.metadata.name=\"tls\"' | jq --arg project_name \"${PROJECT_NAME}\" -r '.metadata.namespace=$project_name' | oc apply -f -\n  ```\n\n1. Create a ConfigMap named `agent-cm` to hold the configuration for the Vaccine Monitoring Agent microservice with the following `oc` command:\n\n  ```shell\n  oc create configmap agent-cm \\\n  --from-literal=REEFER_TOPIC=<YOUR_REEFER_TOPIC> \\\n  --from-literal=TELEMETRY_TOPIC=<YOUR_TELEMETRY_TOPIC> \\\n  --from-literal=KAFKA_BOOTSTRAP_SERVERS=${CLUSTER_NAME}-kafka-bootstrap.${EVENTSTREAMS_NS}.svc:9093 \\\n  --from-literal=QUARKUS_KAFKA_STREAMS_APPLICATION_ID=cold-chain-agent-${YOUR_SUFFIX} \\\n  --from-literal=KAFKA_SECURITY_PROTOCOL=SSL \\\n  --from-literal=TEMPERATURE_THRESHOLD=-30.0 \\\n  --from-literal=PREDICTION_ENABLED=false\n  ```\n\n  where\n\n   - `<YOUR_REEFER_TOPIC>` is the name of the topic that will get the vaccine cold chain temperature violation alert events that you created in the [pre-requisites](#pre-requisites) section.\n   - `<YOUR_TELEMETRY_TOPIC>` is the name of the topic that will get the container telemetries events that you created in the [pre-requisites](#pre-requisites) section.\n   - `<ARE_PREDICTIONS_ENABLED>` will be **true** or **false** depending on whether you completed the [Developing the Anomaly Detection Model with Watson Studio](/analyze/ws-ml-dev/) section or not. If you are not sure, set it to **false**.\n\n1. Deploy Vaccine Monitoring Agent microservice by executing the following `oc` command:\n\n  ```shell\n  oc apply -f https://raw.githubusercontent.com/ibm-cloud-architecture/vaccine-monitoring-agent/master/src/main/kubernetes/deployment.yml\n  ```\n\n  You should see the following output:\n\n  ```shell\n  serviceaccount/reefer-monitoring-agent created\n  service/reefer-monitoring-agent created\n  rolebinding.rbac.authorization.k8s.io/reefer-monitoring-agent-view created\n  imagestream.image.openshift.io/openjdk-11 created\n  deploymentconfig.apps.openshift.io/reefer-monitoring-agent created\n  route.route.openshift.io/reefer-monitoring-agent created\n  ```\n\n## Scenario script\n\nOnce the solution is up and running, execute the following steps to present an end-to-end demonstration:\n\n### Generate vaccine container telemetry events\n\n1. Obtain the Vaccine Reefer Simulator's Flasgger UI via the following `oc` command:\n\n  ```shell\n  oc get route vaccine-reefer-simulator -o jsonpath=\"http://{.status.ingress[0].host}\"\n  ```\n\n1. Open the above url in your web browser and click on the **POST `/control`** API in order to expand it.\n\n  ![flasgger1](./images/flasgger1.png)\n\n1. Click on the **Try it out** button on the top right corner.\n\n1. In the **Edit Value** text box, update the values of the records accordingly:\n\n   ```shell\n   {\n      \"containerID\": \"C21\",\n      \"nb_of_records\": 300,\n      \"product_id\": \"covid-19\",\n      \"simulation\": \"tempgrowth\"\n    }\n   ```\n\n    ![flasgger2](./images/flasgger2.png)\n\n1. Click **Execute**.\n\n### Analyze simulated reefer telemetry data\n\n1. Obtain your IBM Event Streams Console UI's url via the following `oc` command:\n\n  ```shell\n  oc get route -n ${EVENTSTREAMS_NS} ${CLUSTER_NAME}-ibm-es-ui -o jsonpath=\"https://{.status.ingress[0].host}\"\n  ```\n\n1. Open your IBM Event Streams Console UI by pointing your browser to the above url.\n\n1. Click on **Topics** from the left navigation menu and select your `YOUR_TELEMETRY_TOPIC` you created in the [pre-requisites](#pre-requisites) section from the topic list.\n\n1. Explore the messages tab and the individual telemetry records emitted by the Vaccine Reefer Simulator component.\n\n  ![messages](./images/messages.png)\n\n### Analyze generated cold-chain violations\n\n1. Obtain your IBM Event Streams Console UI's url via the following `oc` command:\n\n  ```shell\n  oc get route -n ${EVENTSTREAMS_NS} ${CLUSTER_NAME}-ibm-es-ui -o jsonpath=\"https://{.status.ingress[0].host}\"\n  ```\n\n1. Open your IBM Event Streams Console UI by pointing your browser to the above url.\n\n1. Click on **Topics** from the left navigation menu and select your `YOUR_REEFER_TOPIC` you created in the [pre-requisites](#pre-requisites) section from the topic list.\n\n1. Explore the messages tab and the observed vaccine cold-chain violation alert events.\n\n  ![messages2](./images/messages2.png)\n\n1. The reefer container information contained in this topic have been identified as having observed temperatures outside the allowable range more than the allowable number of times, as determined to preserve the state of the vaccine doses contained.\n\n1. Get the route to the Vaccine Monitoring Agent microservice with the following `oc` command:\n\n  ```shell\n  oc get route reefer-monitoring-agent -o jsonpath=\"http://{.status.ingress[0].host}\"\n  ```\n\n1. Point your browser to the `/swagger-ui` Swagger API endpoint that the Vaccine Monitoring Agent microservice exposes by using the above url. That is, point your browser to `<URL>/swagger-ui/`\n\n  ![messages3](./images/messages3.png)\n\n1. Click on the first API endpoint definition the Swagger UI lists (`/reefer-tracker/data/{reeferID}`) that would allow us to query the Vaccine Monitoring Agent microservice to retrieve the monitoring data for a specific reefer container ID.\n\n1. Once this API endpoint definition gets expanded, click on the **Try it out** button on the top right corner. That will make the `reeferID` text input box active. Insert the reefer ID you used in the previous [Generate vaccine container telemetry events](#generate-vaccine-container-telemetry-events) section to simulate telemetries for and click on **Execute**. You should see the monitoring data for that reefer container similar to the following picture:\n\n  ![messages4](./images/messages4.png)\n\n  where you will see in the reponse body a json object representing the monitoring data for the reefer container you requested it for. You will be able to see if there has been any cold chain temperature violations, how many, the last temperatures, etc...\n\n\n### Clearing the project\n\nTo delete the different resources we have created on your OpenShift cluster throughout this tutorial do the following:\n\n```shell\noc delete -f https://raw.githubusercontent.com/ibm-cloud-architecture/vaccine-monitoring-agent/master/src/main/kubernetes/deployment.yml\noc delete -f https://raw.githubusercontent.com/ibm-cloud-architecture/vaccine-reefer-simulator/master/config/app-deployment.yaml\noc delete project ${PROJECT_NAME}\n```\n\nFinally, delete all the topics created in your IBM Event Streams instance. These are your `YOUR_TELEMETRY_TOPIC` and `YOUR_REEFER_TOPIC` you created in the [pre-requisites](#pre-requisites) section. The other two are internal topics created as a result of the Kafka Streams stateful operations being done in the Vaccine Monitoring Agent microservice code (see [here](https://github.com/ibm-cloud-architecture/vaccine-monitoring-agent/blob/master/src/main/java/ibm/gse/eda/vaccine/coldchainagent/domain/TelemetryAssessor.java#L86-L133) for more detail on those). These two internal topics should have the following names:\n\n```shell\ncold-chain-agent-<YOUR_SUFFIX>-reeferAggregateTable-changelog\ncold-chain-agent-<YOUR_SUFFIX>-reeferAggregateTable-repartition\n```\n\nTo delete these topics, you simply need to go to your IBM Event Streams instance UI dashboard, click on topics on the left hand side navigation menu, click on the three-dots options button that appears on the right hand side of each of the topics in the topics list and select delete.\n","type":"Mdx","contentDigest":"bdaf09cbb6d1c386613ae51b58466c5c","counter":335,"owner":"gatsby-plugin-mdx"},"frontmatter":{"title":"Cold-chain monitoring","description":"Cold-chain monitoring"},"exports":{},"rawBody":"---\ntitle: Cold-chain monitoring\ndescription: Cold-chain monitoring\n---\n\n- UPDATED 02/28/2021 \n\nThe vaccine lots need to be kept at a constant temperature for a period of time. The sensor telemetry data coming from the refrigerated shipping containers is processed to assess cold-chain violations.\n\nThe solution for this use case includes streaming telemetry events, a stateful microservice to implement aggregation & alarm generation, and integration with a microservice to log issues against the refrigerated shipping container.\n\n## Components involved in this use case\n\n* [Vaccine Refrigerator container Simulator](https://github.com/ibm-cloud-architecture/vaccine-reefer-simulator)\n* [Vaccine Reefer Monitoring Agent](https://github.com/ibm-cloud-architecture/vaccine-monitoring-agent)\n* [IBM Event Streams](https://ibm.github.io/event-streams/) or Strimzi Kafka\n\n![Architecture diagram](./images/cc-components.png)\n\n*\\*The reefer manager is not done yet*\n\n## Understand the components\n\n* The Reefer simulator is a python Flask app, which supports simple API to control the Refrigerator container simulation. It is described in [this note](/solution/reefer-iot/), also see next section to deploy it on OpenShift.\n* The Monitoring Agent is a Quarkus app, with Kafka Streams, reactive messaging to monitor the cold chain with stateful operations. It also call the Anomaly detection service. Implementation details can be read in [this note](/solution/cold-monitoring/).\n\n## Run on OpenShift\n\n### Pre-requisites\n\n**IMPORTANT:** If you are sharing the IBM Event Streams instance with other people for this tutorial, you may want to add a unique suffix to the name of the resources to be created next, such as topics, projects, etc. If so, make sure you provide the appropriate name for these throught the rest of the tutorial.\n\n1. Create the following artifacts in the `eventstreams` namespace on your OpenShift cluster (_NOTE: If you happened to have an existing IBM Event Streams instance on a different namespace already, you don't need to create an new one but make sure you use the appropriate namespace name throughout the rest of the tutorial_). We will refer to this namespace as `YOUR_EVENT_STREAMS_NAMESPACE` throughout this tutorial:\n\n   1. Create an EventStreams instance _(via the [Event Streams Custom Resource](https://ibm.github.io/event-streams/installing/installing/#install-an-event-streams-instance))_.\n   1. Create a [Kafka User with SCRAM-based credentials](https://ibm.github.io/event-streams/security/managing-access/#managing-access-to-kafka-resources), as required by the [Vaccine Reefer Simulator](https://github.com/ibm-cloud-architecture/vaccine-reefer-simulator#application-deployment).\n   1. Create a [Kafka User with TLS-based credentials](https://ibm.github.io/event-streams/security/managing-access/#managing-access-to-kafka-resources), as required by the [Vaccine Monitoring Agent](https://github.com/ibm-cloud-architecture/vaccine-monitoring-agent#create-a-tls-user).\n   1. Create two [Kafka Topics](https://ibm.github.io/event-streams/getting-started/creating-topics/). One for the container telemetries events and another for the vaccine cold-chain violation alert events. These topics will be refered as `YOUR_TELEMETRIES_TOPIC` and `YOUR_REEFER_TOPIC` respectively throughout this tutorial. For the instructions on this tutorial, we will assume the names for these two topics to be `reefers.telemetries` and `vaccine.reefers` respectively.\n\n1. Create a new project that will be used for the deployment of all other components. This will be refered as `YOUR_PROJECT_NAME` throughout the rest of this tutorial. For the instructions on this tutorial, We will assume the name for the project is `vaccine-solution`.\n1. [OpenShift CLI](https://cloud.ibm.com/docs/openshift?topic=openshift-openshift-cli) on your local environment.\n1. [jq](https://stedolan.github.io/jq/) on your local environment.\n1. [Kustomize](https://kubectl.docs.kubernetes.io/installation/kustomize/) for one script deploy\n1. Use a Terminal and the `oc` cli. If you want to access the code source you can clone the two main repositories of this solution:\n\n  ```shell\n  git clone https://github.com/ibm-cloud-architecture/vaccine-gitops\n  git clone https://github.com/ibm-cloud-architecture/vaccine-reefer-simulator\n  git clone https://github.com/ibm-cloud-architecture/vaccine-monitoring-agent\n  ```\n\n### TL;DR  - One Click Deploy\n\nGo to `vaccine-gitops` folder and do the following steps:\n\n* Set your personal deployment parameters within the   `scripts/env.sh` file\n* Use the `oc login --token...  --server ....` command to log to the OpenShift cluster. (From the OpenShift admin console, top right menu)\n* Start `./scripts/deployColdChainWithEventStreams.sh --skip-login`\n* The following pods should be up and running:\n\n ```shell\n  NAME                                        READY   STATUS    RESTARTS   AGE\n  reefer-monitoring-agent-7dd5f7ccd9-z4cf9    1/1     Running   0          106s\n  vaccine-reefer-simulator-669c5f5d8b-7mms4   1/1     Running   0          105s\n ```\n\n* Go to the [demonstration section](#scenario-script) to run the demo.\n\n### Deploy the solution manually\n\nIf you want to do this scenario as a lab, then this section addresses how to build and deploy the components to OpenShift:\n\n#### Deploy the Vaccine Reefer Simulator\n\nTo get more details of this Python Flask application [read this note](/solution/reefer-iot/).\n\n1. Export your project name and ensure you are working in it from now on via the following commands:\n\n  ```shell\n  export PROJECT_NAME=<YOUR_PROJECT_NAME>\n  oc project ${PROJECT_NAME}\n  ```\n\n  where\n\n   - `<YOUR_PROJECT_NAME>` is the name for the project you created in the previous [pre-requisites](#pre-requisites) section where all the components for this cold chain solution will be deployed into.\n\n1. Export the value of your Event Streams cluster name and the namespace it is installed on to environment variables:\n\n  ```shell\n  export CLUSTER_NAME=<YOUR_CLUSTER_NAME>\n  export EVENTSTREAMS_NS=<YOUR_EVENT_STREAMS_NAMESPACE>\n  ```\n\n  where\n\n   - `<YOUR_EVENT_STREAMS_NAMESPACE>` is the name where you installed your IBM Event Streams instance in the [pre-requisites](#pre-requisites) section above.\n   - `<YOUR_CLUSTER_NAME>` is the name of your IBM Event Streams cluster which can be found with the following `oc` command:\n\n   ```shell\n   $ oc get eventstreams -n ${EVENTSTREAMS_NS}\n   NAME           STATUS\n   eda-dev    Ready\n   ```\n\n1. Create a ConfigMap named `reefer-simul-cm` to hold the configuration for our Vaccine Reefer Simulator component with the following `oc` command:\n\n  ```shell\n  oc create configmap reefer-simul-cm \\\n  --from-literal=KAFKA_MAIN_TOPIC=<YOUR_TELEMETRY_TOPIC> \n  ```\n\n  where\n\n   - `<YOUR_TELEMETRY_TOPIC>` is the name of the topic that will get the container telemetries events you created in the [pre-requisites](#pre-requisites) section.\n   - `<YOUR_KAFKA_BOOTSTRAP_EXTERNAL_ADDRESS>` is your IBM Event Streams **External** cluster bootstrap address presented to you during the creation of your SCRAM-based KafkaUser you went through in the [pre-requisites](#pre-requisites) section. You can get that value again by executing the following `oc` command:\n    ```shell\n    oc get route -n ${EVENTSTREAMS_NS} ${CLUSTER_NAME}-kafka-bootstrap -o jsonpath=\"{.status.ingress[0].host}:443\"\n    ```\n\n1. Create a Secret named `reefer-simul-secret`, which will hold your SCRAM Kafka User credentials you created in the [pre-requisites](#pre-requisites) section, with the following `oc` command:\n\n  ```shell\n  oc create secret generic reefer-simul-secret \\\n  --from-literal=KAFKA_BROKERS=<YOUR_KAFKA_BOOTSTRAP_EXTERNAL_ADDRESS>\n  ```\n\n  where\n\n   - `<YOUR_SCRAM_KAFKA_USER_USERNAME>` is the name you gave in the [pre-requisites](#pre-requisites) section when you generated the SCRAM credentials. The generation of the SCRAM credential created a KafkaUser object behind the scenes with the name you specified. If you don't remember that name or you want to verify it, you can use the following `oc` command:\n   ```shell\n   $ oc get kafkausers -n ${EVENTSTREAMS_NS}\n   NAME                    CLUSTER         AUTHENTICATION   AUTHORIZATION\n   scram-user           eda-dev     scram-sha-512    simple\n   ```\n   - `<YOUR_SCRAM_KAFKA_USER_PASSWORD>` is the password that IBM Event Streams generated for the KafkaUser that got created behind the scenes when you generated the SCRAM credentials in the [pre-requisites](#pre-requisites) section. You can retrieve that password with the following `oc` command:\n   ```shell\n   oc get secret <YOUR_SCRAM_KAFKA_USER_USERNAME> -n ${EVENTSTREAMS_NS} -o jsonpath='{.data.password}' | base64 -D\n   ```\n\n1. Copy the server-side public TLS certificate of your IBM Event Streams instance to your local project so that the Vaccine Reefer Simulator application is able to establish secure connection with your IBM Event Streams instance:\n\n  ```shell\n  oc get secret ${CLUSTER_NAME}-cluster-ca-cert -n ${EVENTSTREAMS_NS} -o json | jq -r '.metadata.name=\"kafka-cluster-ca-cert\"' | jq --arg project_name \"${PROJECT_NAME}\" -r '.metadata.namespace=$project_name' | oc apply -f -\n  ```\n  _\\*NOTE: We are copying and renaming the certificate in a single command to minimize the need for editing deployment documents. That is, we are providing the server-side TLS certificate in the secret the Vaccine Reefer Simulator and the Vaccine Monitoring Agent microservices are expecting to find it._\n\n1. Compile, build the docker image and push to the registry\n\n  ```shell\n  # In the vaccine simulator project \n  docker build -t ibmcase/vaccine-reefer-simulator  .\n  docker push ibmcase/vaccine-reefer-simulator \n  ```\n\n1. Deploy Vaccine Reefer Simulator microservice components (application plus a service and a route to make it accessible) via the following `oc apply` command:\n\n  ```shell\n  oc apply -f https://raw.githubusercontent.com/ibm-cloud-architecture/vaccine-reefer-simulator/master/config/deployment.yaml\n  oc apply -f https://raw.githubusercontent.com/ibm-cloud-architecture/vaccine-reefer-simulator/master/config/deployment.yaml\n  ```\n\n   - You should see the following output:\n\n   ```shell\n   service/vaccine-reefer-simulator created\n   route.route.openshift.io/vaccine-reefer-simulator created\n   odeployment.apps/vaccine-reefer-simulator created\n   ```\n\n   - You can verify the deployment state with the following `oc` command:\n\n   ```shell\n   oc get pods\n   NAME                                       READY   STATUS    RESTARTS   AGE\n   vaccine-reefer-simulator-7dcfcf5cb-4nvl7   1/1     Running   0          5m55s\n   ```\n\n   or the via the Openshift console:\n\n   ![2](./images/simul-app-ocp.png)\n\n  \\*_NOTE: If you want to build from scratch, clone [the repository](https://github.com/ibm-cloud-architecture/vaccine-reefer-simulator) and follow the README._\n\n1. Get the route to access the Vaccine Reefer Simulator application with the `oc get routes` command.\n\n\n#### Deploy the Vaccine Monitoring Agent\n\nTo get more detail of this Java Quarkus microprofile application [read this note](/solution/cold-monitoring/). The project repository is in this [GitHub repository](https://github.com/ibm-cloud-architecture/vaccine-monitoring-agent). Follow the steps below to get the Vaccine Monitoring Agent microservice deployed on your OpenShift cluster:\n\n\n1. Ensure you are working inside the correct project via the following `oc` command:\n\n  ```shell\n  oc project ${PROJECT_NAME}\n  ```\n\n1. Export the value of your TLS-based KafkaUser name and a unique identifier for the reources to be created into your OpenShift cluster as environment variables so that the following steps in this section can make use of these.\n\n  ```shell\n  export TLS_USER=<YOUR_TLS_USER>\n  # we use tls-user\n  export YOUR_SUFFIX=<UNIQUE_IDENTIFIER>\n  ```\n\n  where\n\n   - `<YOUR_TLS_USER>` is the name you gave when creating the tls credentials in the [pre-requisites](#pre-requisites) section. If you don't remember the tls KafkaUser you created, you can check it out with the following `oc` command:\n    ```shell\n    $ oc get kafkausers -n ${EVENTSTREAMS_NS}\n    NAME                  CLUSTER         AUTHENTICATION   AUTHORIZATION\n    tls-user             eda-dev     tls              simple\n    ```\n    _\\*NOTE: We are copying and renaming the credentials in a single command to minimize the need for editing deployment documents._\n   - `<UNIQUE_IDENTIFIER>` is a unique identifier of your choice to be used as the suffix for any resource created in OpenShift and IBM Event Streams so that it does not collide with anyone else also completing this tutorial.\n\n1. If not done so already in the previous section where we deployed the Vaccine Reefer Simulator microservice, copy the server-side public certificate of the Event Streams instance to your local project:\n\n  ```shell\n  oc get secret ${CLUSTER_NAME}-cluster-ca-cert -n ${EVENTSTREAMS_NS} -o json | jq -r '.metadata.name=\"kafka-cluster-ca-cert\"' | jq --arg project_name \"${PROJECT_NAME}\" -r '.metadata.namespace=$project_name' | oc apply -f -\n  ```\n  _\\*NOTE: We are copying and renaming the certificate in a single command to minimize the need for editing deployment documents. That is, we are providing the server-side TLS certificate in the secret the Vaccine Reefer Simulator and the Vaccine Monitoring Agent microservices are expecting to find it._\n\n1. Copy your TLS-based KafkaUser's credentials you created in the [pre-requisites](#pre-requisites) section to the local namespace with the following `oc` command:\n\n  ```shell\n  oc get secret ${TLS_USER} -n ${EVENTSTREAMS_NS} -o json | jq -r '.metadata.name=\"tls\"' | jq --arg project_name \"${PROJECT_NAME}\" -r '.metadata.namespace=$project_name' | oc apply -f -\n  ```\n\n1. Create a ConfigMap named `agent-cm` to hold the configuration for the Vaccine Monitoring Agent microservice with the following `oc` command:\n\n  ```shell\n  oc create configmap agent-cm \\\n  --from-literal=REEFER_TOPIC=<YOUR_REEFER_TOPIC> \\\n  --from-literal=TELEMETRY_TOPIC=<YOUR_TELEMETRY_TOPIC> \\\n  --from-literal=KAFKA_BOOTSTRAP_SERVERS=${CLUSTER_NAME}-kafka-bootstrap.${EVENTSTREAMS_NS}.svc:9093 \\\n  --from-literal=QUARKUS_KAFKA_STREAMS_APPLICATION_ID=cold-chain-agent-${YOUR_SUFFIX} \\\n  --from-literal=KAFKA_SECURITY_PROTOCOL=SSL \\\n  --from-literal=TEMPERATURE_THRESHOLD=-30.0 \\\n  --from-literal=PREDICTION_ENABLED=false\n  ```\n\n  where\n\n   - `<YOUR_REEFER_TOPIC>` is the name of the topic that will get the vaccine cold chain temperature violation alert events that you created in the [pre-requisites](#pre-requisites) section.\n   - `<YOUR_TELEMETRY_TOPIC>` is the name of the topic that will get the container telemetries events that you created in the [pre-requisites](#pre-requisites) section.\n   - `<ARE_PREDICTIONS_ENABLED>` will be **true** or **false** depending on whether you completed the [Developing the Anomaly Detection Model with Watson Studio](/analyze/ws-ml-dev/) section or not. If you are not sure, set it to **false**.\n\n1. Deploy Vaccine Monitoring Agent microservice by executing the following `oc` command:\n\n  ```shell\n  oc apply -f https://raw.githubusercontent.com/ibm-cloud-architecture/vaccine-monitoring-agent/master/src/main/kubernetes/deployment.yml\n  ```\n\n  You should see the following output:\n\n  ```shell\n  serviceaccount/reefer-monitoring-agent created\n  service/reefer-monitoring-agent created\n  rolebinding.rbac.authorization.k8s.io/reefer-monitoring-agent-view created\n  imagestream.image.openshift.io/openjdk-11 created\n  deploymentconfig.apps.openshift.io/reefer-monitoring-agent created\n  route.route.openshift.io/reefer-monitoring-agent created\n  ```\n\n## Scenario script\n\nOnce the solution is up and running, execute the following steps to present an end-to-end demonstration:\n\n### Generate vaccine container telemetry events\n\n1. Obtain the Vaccine Reefer Simulator's Flasgger UI via the following `oc` command:\n\n  ```shell\n  oc get route vaccine-reefer-simulator -o jsonpath=\"http://{.status.ingress[0].host}\"\n  ```\n\n1. Open the above url in your web browser and click on the **POST `/control`** API in order to expand it.\n\n  ![flasgger1](./images/flasgger1.png)\n\n1. Click on the **Try it out** button on the top right corner.\n\n1. In the **Edit Value** text box, update the values of the records accordingly:\n\n   ```shell\n   {\n      \"containerID\": \"C21\",\n      \"nb_of_records\": 300,\n      \"product_id\": \"covid-19\",\n      \"simulation\": \"tempgrowth\"\n    }\n   ```\n\n    ![flasgger2](./images/flasgger2.png)\n\n1. Click **Execute**.\n\n### Analyze simulated reefer telemetry data\n\n1. Obtain your IBM Event Streams Console UI's url via the following `oc` command:\n\n  ```shell\n  oc get route -n ${EVENTSTREAMS_NS} ${CLUSTER_NAME}-ibm-es-ui -o jsonpath=\"https://{.status.ingress[0].host}\"\n  ```\n\n1. Open your IBM Event Streams Console UI by pointing your browser to the above url.\n\n1. Click on **Topics** from the left navigation menu and select your `YOUR_TELEMETRY_TOPIC` you created in the [pre-requisites](#pre-requisites) section from the topic list.\n\n1. Explore the messages tab and the individual telemetry records emitted by the Vaccine Reefer Simulator component.\n\n  ![messages](./images/messages.png)\n\n### Analyze generated cold-chain violations\n\n1. Obtain your IBM Event Streams Console UI's url via the following `oc` command:\n\n  ```shell\n  oc get route -n ${EVENTSTREAMS_NS} ${CLUSTER_NAME}-ibm-es-ui -o jsonpath=\"https://{.status.ingress[0].host}\"\n  ```\n\n1. Open your IBM Event Streams Console UI by pointing your browser to the above url.\n\n1. Click on **Topics** from the left navigation menu and select your `YOUR_REEFER_TOPIC` you created in the [pre-requisites](#pre-requisites) section from the topic list.\n\n1. Explore the messages tab and the observed vaccine cold-chain violation alert events.\n\n  ![messages2](./images/messages2.png)\n\n1. The reefer container information contained in this topic have been identified as having observed temperatures outside the allowable range more than the allowable number of times, as determined to preserve the state of the vaccine doses contained.\n\n1. Get the route to the Vaccine Monitoring Agent microservice with the following `oc` command:\n\n  ```shell\n  oc get route reefer-monitoring-agent -o jsonpath=\"http://{.status.ingress[0].host}\"\n  ```\n\n1. Point your browser to the `/swagger-ui` Swagger API endpoint that the Vaccine Monitoring Agent microservice exposes by using the above url. That is, point your browser to `<URL>/swagger-ui/`\n\n  ![messages3](./images/messages3.png)\n\n1. Click on the first API endpoint definition the Swagger UI lists (`/reefer-tracker/data/{reeferID}`) that would allow us to query the Vaccine Monitoring Agent microservice to retrieve the monitoring data for a specific reefer container ID.\n\n1. Once this API endpoint definition gets expanded, click on the **Try it out** button on the top right corner. That will make the `reeferID` text input box active. Insert the reefer ID you used in the previous [Generate vaccine container telemetry events](#generate-vaccine-container-telemetry-events) section to simulate telemetries for and click on **Execute**. You should see the monitoring data for that reefer container similar to the following picture:\n\n  ![messages4](./images/messages4.png)\n\n  where you will see in the reponse body a json object representing the monitoring data for the reefer container you requested it for. You will be able to see if there has been any cold chain temperature violations, how many, the last temperatures, etc...\n\n\n### Clearing the project\n\nTo delete the different resources we have created on your OpenShift cluster throughout this tutorial do the following:\n\n```shell\noc delete -f https://raw.githubusercontent.com/ibm-cloud-architecture/vaccine-monitoring-agent/master/src/main/kubernetes/deployment.yml\noc delete -f https://raw.githubusercontent.com/ibm-cloud-architecture/vaccine-reefer-simulator/master/config/app-deployment.yaml\noc delete project ${PROJECT_NAME}\n```\n\nFinally, delete all the topics created in your IBM Event Streams instance. These are your `YOUR_TELEMETRY_TOPIC` and `YOUR_REEFER_TOPIC` you created in the [pre-requisites](#pre-requisites) section. The other two are internal topics created as a result of the Kafka Streams stateful operations being done in the Vaccine Monitoring Agent microservice code (see [here](https://github.com/ibm-cloud-architecture/vaccine-monitoring-agent/blob/master/src/main/java/ibm/gse/eda/vaccine/coldchainagent/domain/TelemetryAssessor.java#L86-L133) for more detail on those). These two internal topics should have the following names:\n\n```shell\ncold-chain-agent-<YOUR_SUFFIX>-reeferAggregateTable-changelog\ncold-chain-agent-<YOUR_SUFFIX>-reeferAggregateTable-repartition\n```\n\nTo delete these topics, you simply need to go to your IBM Event Streams instance UI dashboard, click on topics on the left hand side navigation menu, click on the three-dots options button that appears on the right hand side of each of the topics in the topics list and select delete.\n","fileAbsolutePath":"/home/runner/work/vaccine-solution-main/vaccine-solution-main/docs/src/pages/use-cases/cold-chain/index.mdx"}}}}